create PROCEDURE dbo.xsp_et_main_update_backup_20241120
(
	@p_code				nvarchar(50)
	,@p_et_date			datetime
	,@p_et_remarks		nvarchar(4000)  
	,@p_agreement_no    nvarchar(50)
	--
	,@p_mod_date		datetime
	,@p_mod_by			nvarchar(15)
	,@p_mod_ip_address	nvarchar(15)
)
as
begin
	declare @msg			nvarchar(max) 
			,@et_exp_date	datetime 
			,@total_amount	decimal(18, 2); 

	begin try
		select	@et_exp_date = dateadd(day, cast(value as int), @p_et_date)
		from	dbo.sys_global_param
		where	code = 'EXPOPL' ; 
		
			IF (@p_agreement_no NOT IN ( '0000870.4.08.12.2022', '0001081.4.01.07.2022', '0001034.4.01.05.2022',
										 '0002090.4.10.03.2024', '0000942.4.01.12.2021', '0001089.4.08.08.2023',
										 '0001090.4.08.08.2023', '0001091.4.08.08.2023', '0000599.4.01.01.2021',
										 '0000600.4.01.01.2021', '0001829.4.10.01.2024', '0001556.4.01.11.2023',
										 '0001784.4.10.01.2024', '0000003.4.34.03.2021', '0001183.4.08.10.2023',
										 '0001695.4.01.01.2024', '0000128.4.03.02.2022', '0001777.4.10.01.2024',
										 '0001203.4.01.12.2022', '0002100.4.10.03.2024', '0000125.4.03.02.2022',
										 '0002140.4.10.03.2024', '0001058.4.08.07.2023', '0000869.4.01.10.2021',
										 '0000038.4.38.03.2023', '0001751.4.10.01.2024', '0000220.4.03.09.2023',
										 '0000008.4.11.12.2021', N'0000028.4.06.04.2022', N'0000029.4.06.04.2022',
										 N'0000060.4.03.08.2021', N'0000061.4.03.08.2021', N'0000062.4.03.08.2021',
										 N'0000063.4.03.09.2021', N'0000064.4.03.09.2021', N'0000065.4.03.09.2021',
										 N'0000066.4.03.10.2021', N'0000080.4.38.08.2023', N'0000081.4.38.08.2023',
										 N'0000112.4.38.09.2023', N'0000118.4.03.04.2022', N'0000119.4.03.03.2022',
										 N'0000120.4.03.04.2022', N'0000121.4.03.03.2022', N'0000122.4.03.04.2022',
										 N'0000130.4.03.04.2022', N'0000131.4.03.04.2022', N'0000132.4.03.06.2022',
										 N'0000133.4.03.06.2022', N'0000134.4.03.06.2022', N'0000208.4.03.08.2023',
										 N'0000212.4.03.08.2023', N'0000216.4.03.09.2023', N'0000227.4.03.09.2023',
										 N'0000228.4.03.09.2023', N'0001507.4.01.09.2023', N'0001688.4.01.12.2023',
										 N'0001773.4.08.01.2024', N'0001844.4.08.01.2024', N'0001900.4.08.02.2024',
										 N'0002183.4.10.04.2024', N'0002184.4.10.04.2024', N'0002185.4.10.04.2024',
										 N'0002186.4.10.04.2024', N'0002327.4.10.05.2024', N'0002332.4.08.05.2024',
										 '0002735.4.10.08.2024', '0002700.4.08.08.2024', '0000038.4.38.03.2023',
										 '0002825.4.08.09.2024', '0002826.4.08.09.2024', '0002883.4.08.09.2024',
										 '0002873.4.08.09.2024', '0002916.4.08.09.2024', '0002962.4.08.09.2024',
										 '0002926.4.08.09.2024', '0002880.4.08.09.2024', '0002918.4.08.09.2024',
										 '0002963.4.08.09.2024', '0003025.4.08.10.2024', '0002887.4.08.09.2024',
										 '0003064.4.08.10.2024', '0002889.4.08.09.2024', '0002940.4.08.09.2024',
										 '0003053.4.08.10.2024', '0002972.4.08.09.2024', '0003033.4.08.10.2024',
										 '0002941.4.08.09.2024', '0003014.4.08.10.2024', '0002946.4.08.09.2024',
										 '0003035.4.08.10.2024', '0003064.4.08.10.2024', '0003052.4.08.10.2024',
										 '0003029.4.08.10.2024', '0002937.4.08.09.2024', '0003093.4.08.10.2024',
										 '0002976.4.08.09.2024', '0002922.4.08.09.2024', '0002968.4.08.09.2024',
										 '0001416.4.01.07.2023', '0002437.4.10.06.2024', '0000238.4.10.07.2019',
										 '0000237.4.10.07.2019', '0002822.4.08.09.2024', '0002853.4.08.09.2024',
										 '0002865.4.08.09.2024', '0002867.4.08.09.2024', '0002870.4.08.09.2024',
										 '0002877.4.08.09.2024', '0002879.4.08.09.2024', '0002899.4.08.09.2024',
										 '0002902.4.08.09.2024', '0002912.4.08.09.2024', '0002921.4.08.09.2024',
										 '0002932.4.08.09.2024', '0002945.4.08.09.2024', '0002977.4.08.09.2024',
										 '0003000.4.08.10.2024', '0003001.4.08.10.2024', '0003003.4.08.10.2024',
										 '0003009.4.08.10.2024', '0003021.4.08.10.2024', '0003022.4.08.10.2024',
										 '0003030.4.08.10.2024', '0003038.4.08.10.2024', '0003042.4.08.10.2024',
										 '0003043.4.08.10.2024', '0003048.4.08.10.2024', '0003063.4.08.10.2024',
										 '0003078.4.08.10.2024', '0003079.4.08.10.2024', '0003085.4.08.10.2024',
										 '0003103.4.08.10.2024', '0003108.4.08.10.2024', '0003109.4.08.10.2024',
										 '0003111.4.08.10.2024', '0003115.4.08.10.2024', '0003128.4.08.10.2024',
										 '0003146.4.08.10.2024', '0003153.4.08.10.2024', '0003156.4.08.10.2024',
										 '0003163.4.08.10.2024', '0003167.4.08.10.2024', '0003169.4.08.10.2024',
										 '0003181.4.08.10.2024', '0003182.4.08.10.2024','0000771.4.10.09.2023','0000237.4.10.07.2019','0000238.4.10.07.2019','0000181.4.04.05.2023'
										 ,'0000181.4.04.05.2023'
									   )
			   ) --untuk data maintenance
			BEGIN
				IF (@p_et_date < dbo.xfn_get_system_date())
				BEGIN
					SET @msg = dbo.xfn_get_msg_err_must_be_greater_or_equal_than('Date', 'System Date');

					RAISERROR(@msg, 16, 1);
				END;
			END;
		
		-- untuk mereeset jika terjadi perubahan tgl pada etmain update ke et_detail isterminate menjadi 1
		if exists
		(
			select	1
			from	dbo.et_main
			where	code		= @p_code
					and et_date <> @p_et_date
		)
		begin
			--update	dbo.et_detail
			--set		is_terminate = '1'
			--where	et_code = @p_code ;
			
		 
			--insert to et_transaction
			exec dbo.xsp_et_transaction_generate @p_et_code			= @p_code
												 ,@p_agreement_no	= @p_agreement_no
												 ,@p_et_date		= @p_et_date
												 ,@p_cre_date		= @p_mod_date		
												 ,@p_cre_by			= @p_mod_by			
												 ,@p_cre_ip_address = @p_mod_ip_address	
												 ,@p_mod_date		= @p_mod_date
												 ,@p_mod_by			= @p_mod_by
												 ,@p_mod_ip_address = @p_mod_ip_address

			select	@total_amount = isnull(sum(total_amount), 0)
			from	dbo.et_transaction
			where	et_code			   = @p_code
					and is_transaction = '1' ;

			update	dbo.et_main
			set		et_amount		   = @total_amount
					--
					,@p_mod_date	   = @p_mod_date
					,@p_mod_by		   = @p_mod_by
					,@p_mod_ip_address = @p_mod_ip_address 
			where	code			   = @p_code ;
		end ;

		update	et_main
		set		et_date						= @p_et_date
				,et_exp_date				= @et_exp_date
				,et_remarks					= @p_et_remarks 
				--
				,mod_date					= @p_mod_date
				,mod_by						= @p_mod_by
				,mod_ip_address				= @p_mod_ip_address
		where	code						= @p_code ;
				
	end try
	begin catch
		declare @error int ;

		set @error = @@error ;

		if (@error = 2627)
		begin
			set @msg = dbo.xfn_get_msg_err_code_already_exist() ;
		end ;

		if (len(@msg) <> 0)
		begin
			set @msg = 'V' + ';' + @msg ;
		end ;
		else
		begin
			if (error_message() like '%V;%' or error_message() like '%E;%')
			begin
				set @msg = error_message() ;
			end
			else 
			begin
				set @msg = 'E;' + dbo.xfn_get_msg_err_generic() + ';' + error_message() ;
			end
		end ;

		raiserror(@msg, 16, -1) ;

		return ;
	end catch ; 
end ;

